
# web-socket сервер Лаванда

Запуск ноды: `$ node index.js`

Запуск демоном: `$ pm2 start index.js`

Логи: `$ pm2 log index`

## Требования

Наличие сервера redis

## Описание

Лаванда веб-сокет сервер для работы в параллели с веб-сайтом или приложением.
Используется для рассылки уведомлений, организации пользовательской переписки, чатов.

Для защиты от посторонних подключений используется сравнение сессионных ключей пользователей через Redis.
Веб-сайт обязуется писать в Redis пару: userId:sessionId. 

Лаванда при подключении нового пользователя получает из Redis сессионный ключ по идентификатору и сравнивает с полученным ключом через заголовки во время подключения.
Если ключи не совпадают, в подключении будет отказано.

Совершенно не обязательно использование именно чистой сессии. в качестве сессионного ключа может выступать любой token авторизации сгенерированный веб-сервером.  

Лаванда допускает множественные подключения одного пользователя (несколько вкладок)
в таком случае если к этому пользователю потребуется отправить сообщение, то каждый его софт-клиент получит сообщение.

### Параметры подключения

Для подключения к нашему серверу каждый клиент должен передать следущие параметры в строке запросе:
* string **userId** - строковый идентификатор анонима или integer ID для авторизованного клиента
* string **softId** - идентификатор приложения откуда подключается клиент
 
В Заголовке:

* string **sessid** - идентификатор сессии пользователя. Так как броузерные приложения на javascript не могут передавать пользовательские заголовки при подключении, обходим это черезх передачу в subprotocol: 

Пример в клиенте на Node.js c заголовками:  
```javascript
var client = new WebSocketClient();
client.connect('wss://127.0.0.1:3000/?userId={%id%}&softid={%softId%}',
    'echo-protocol',
    null,
    {'sessid': sessId});
```

Пример в клиенте на javascript с использованием subprotocol:
```javascript
socket = new WebSocket("ws://lavanda.site:3000?userId=" + userId + "&softId=" + softId, sessId);
```

### Передача сообщений на сервер

Передача сообщений требует нескольких обязательных параметров:
* module - имя модуля который примет сообщение
* method - имя метода который будет обрабатывать сообщение

Необязательные параметры:
* userId - ID юзера которому направлено сообщение
* text   - Текстовое сообщение

Пример вызова:
```javascript
client.connection.sendUTF(JSON.stringify({
    module: 'notice', 
    userId: 1, 
    method: 'notice', 
    text: 'Уведомление о том что всё работает!'
}));
```

### Модули

Планируется 4 модуля для работы: 
* Модуль администратора - для получения технической информации и управления.
* Уведомления - модуль для отправки уведомлений.
* Приватные сообщения - прямое общение между пользователями.
* Чат - общение пользователей в группах/комнатах с модерацией.
