
# web-socket сервер Лаванда

Запуск ноды: `$ node index.js`

Запуск демоном: `$ pm2 start index.js`

Логи: `$ pm2 log index`

## Требования

Наличие сервера redis

## Описание

Лаванда веб-сокет сервер для работы в параллели с веб-сайтом или приложением.
Используется для рассылки уведомлений, организации пользовательской переписки, чатов.

Для защиты от посторонних подключений используется сравнение сессионных ключей пользователей через Redis.
Веб-сайт обязуется писать в Redis пару: userId:sessionId. 

Лаванда при подключении нового пользователя получает из Redis сессионный ключ по идентификатору и сравнивает с полученным ключом через заголовки во время подключения.
Если ключи не совпадают, в подключении будет отказано.

Совершенно не обязательно использование именно чистой сессии. в качестве сессионного ключа может выступать любой token авторизации сгенерированный веб-сервером.  

Лаванда допускает множественные подключения одного пользователя (несколько вкладок)
в таком случае если к этому пользователю потребуется отправить сообщение, то каждый его софт-клиент получит сообщение.

### Параметры подключения

Для подключения к нашему серверу каждый клиент должен передать следущие параметры в строке запросе:
* string **userId** - строковый идентификатор анонима или integer ID для авторизованного клиента
* string **softId** - идентификатор приложения откуда подключается клиент
 
В Заголовке:

* string **sessid** - идентификатор сессии пользователя. Так как броузерные приложения на javascript не могут передавать пользовательские заголовки при подключении, обходим это черезх передачу в subprotocol: 

Пример в клиенте на Node.js c заголовками:  
```javascript
var client = new WebSocketClient();
client.connect('wss://127.0.0.1:3000/?userId={%id%}&softid={%softId%}',
    'echo-protocol',
    null,
    {'sessid': sessId});
```

Пример в клиенте на javascript с использованием subprotocol:
```javascript
socket = new WebSocket("ws://lavanda.site:3000?userId=" + userId + "&softId=" + softId, sessId);
```

### Передача сообщений на сервер

Передача сообщений требует нескольких обязательных параметров:
* module - имя модуля который примет сообщение
* method - имя метода который будет обрабатывать сообщение

Необязательные параметры:
* userId - ID юзера которому направлено сообщение
* text   - Текстовое сообщение

Пример вызова:
```javascript
client.connection.sendUTF(JSON.stringify({
    module: 'notice', 
    userId: 1, 
    method: 'notice', 
    text: 'Уведомление о том что всё работает!'
}));
```

### Получение сообщений

Каждое сообщение полученное от сервера содержит два обязательных поля:
* string **module** - имя модуля который отправил ответ
* object **options** - вся остальная информация:
  * string **type** - имя метода отправившего ответ
  * string **format** - формат сообщения (text|json)
  * string **sender** - идентификатор отправителя сообщения, именно userId (см выше).
  * string **message** - сообщение.

Если формат сообщения json, после его получения поле `message` требуется распарсить:

```javascript
let userList = JSON.parse(inputMessage.options.message);
```

## Модули

Планируется 5 модулей для работы:
* Модуль пользователя - работа с данными пользователя.
* Модуль администратора - для получения технической информации и управления.
* Уведомления - модуль для отправки уведомлений.
* Приватные сообщения - прямое общение между пользователями.
* Чат - общение пользователей в группах/комнатах с модерацией.

### Модуль пользователей

Передача личных данных
поле isAdmin определяет доступ к запросам в Модуль администратора
остальные данные не регламентированы и можно передавать поля какие угодно.

```javascript
client.connection.sendUTF(JSON.stringify({
    module: 'user',
    method: 'setData',
    name: "Иван",
    lastName: "Никаноров",
    login: "Nikan",
    isAdmin: true
}));
```

### Модуль администратора

Метод **countuser** - получение данных о количестве подключенных пользователей

```javascript
client.connection.sendUTF(JSON.stringify({
    module: 'admin',
    method: 'countuser'
}));
```

В ответ сервер отправляет сообщение с количеством пользователей:

```json
{
  "module": "admin",
  "options": {
    "type": "countuser",
    "format": "text",
    "sender": "123",
    "message": "3"
  }
}
```

Метод **userlist** - получение списка пользователей.

```javascript
client.connection.sendUTF(JSON.stringify({
    module: 'admin',
    method: 'userlist'
}));
```

В ответ сервер отправляет сообщение со списком пользователей:
поля пользователя:
* string **id**      - идентификатор пользователя, именно userId
* bool   **isAdmin** - флаг администратора
* object **data**    - набор полей передаваемых методом user::setData
```json
[
  {
    "id": "123",
    "isAdmin": true,
    "data": {
      "name": "Иван",
      "lastName": "Иванов",
      "login": "Ivanov"
    }
  }
]
```
